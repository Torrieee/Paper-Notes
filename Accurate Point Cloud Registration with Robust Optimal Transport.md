# 1. 理解论文的RobOT计算公式

参考：

- https://zhuanlan.zhihu.com/p/430016990
- chatgpt

![image-20241008183735040](C:\Users\Dell\AppData\Roaming\Typora\typora-user-images\image-20241008183735040.png)

### 公式说明：

- **点云 A 和 B**：设 $A = (x_1, \dots, x_N)$ 和 $B = (y_1, \dots, y_N)$分别是两个位于三维空间 $\mathbb{R}^3$ 中的点云，且 N = M，即两个点云中的点数相同。
- **目标**：该问题的目标是通过寻找一个最优的排列 $ s $ （即一个从 $ [1, N] $ 到 $ [1, N] $ 的置换），使得从点云 A 到点云 B 的匹配代价（这里是欧氏距离的平方和）最小。
- **数学表达**：
  $
  \text{Assignment}(A, B) = \frac{1}{2N} \min_{s:[1,N]\to [1,N]} \sum_{i=1}^{N} \|x_i - y_{s(i)}\|_{\mathbb{R}^3}^2$
- 其中，$s$ 是一个置换，使得每个点 $x_i$ 都与 $ y_{s(i)}$ 匹配，且目标是找到最优的 $ s $ 使得上述和最小化。

### 问题描述：
- **排序的泛化**：这个问题实际上是对点集 $A$ 和 $ B $ 之间的**最优排序**问题的泛化。如果所有的点 $ x_i $ 和 $ y_j $ 都**在一条直线**上，那么最优置换 $ s^* $ 就相当于对点集 A 和 B 进行非递减顺序的重新排序。
  - 这里假设所有的点 $ x_i $ 和 $ y_j $ 都**在一条直线**上

    1. **点在线上**：假设点集 $ A $ 和 $ B $ 中的所有点都在一条直线上，那么每个点 $ x_i $ 和对应的点 $ y_j $ 都有明确的**相对位置关系**。这些点可以按坐标（比如在一维空间中）排序。比如，假设点集 A 和 B 的点在同一条直线上，且分别是 $[x_1, x_2, x_3]$ 和 $[y_1, y_2, y_3]$，如果 $ x_1 < x_2 < x_3 $，而 $ y_2 < y_1 < y_3 $，那么最优置换 $ s^* $ 就会是将 $ x_1 $ 与 $ y_2 $ 匹配， $ x_2 $ 与 $ y_1 $ 匹配， $ x_3 $ 与 $ y_3 $ 匹配，使得所有配对之间的距离最小。
    2. 在三维空间中，当我们说“点在一条直线上”，这意味着所有点 $x_i$ 和 $y_j$ 都在某个方向上的一条直线上。即使是在三维空间中，如果所有点都共线，我们仍可以为这些点定义一个排序方式，方法如下：
       1. **定义直线方向**：
          - 假设所有点都位于一条直线上，那么这条直线可以用一个方向向量 $ \mathbf{d} $ 来定义。向量 $ \mathbf{d} $ 表示这条直线的方向，通常可以通过任意两个点之间的差值计算出这个方向向量，比如 $ \mathbf{d} = \mathbf{y}_j - \mathbf{x}_i $。
       2. **投影到直线**：
          - 对于每一个点 $ x_i $ 和 $ y_j $，我们可以将它们在该方向向量上的投影计算出来。投影的计算公式为：
          $t_i = \frac{(\mathbf{x}_i - \mathbf{o}) \cdot \mathbf{d}}{|\mathbf{d}|^2}$。其中，$ \mathbf{o} $ 是直线上的某个参考点，通常可以选择直线上的任意一点（比如 $ \mathbf{x}_1 $ 或 $ \mathbf{y}_1 $），而 $ \mathbf{d} $ 是直线的方向向量。$ t_i $ 是点 $ x_i $ 在该直线上的投影长度。
       3. **投影值排序**：
          - 现在，我们已经将所有点投影到直线上，并得到一个标量值 $ t_i $，这些标量是沿着直线的距离。这些投影标量值可以作为对点集排序的依据。根据投影值的大小，对所有点进行从小到大的排序，从而在三维空间的直线上确定点的顺序。




如果点集 $ A $ 和 $ B $ 中的点不在一条直线上，那么问题会更加复杂，此时无法简单地通过投影来排序点集，需要借助更复杂的算法来找到**最优的匹配方式**。以下是几种常见的处理方式：

**1. 点云配准（Point Cloud Registration）**：

点云配准是指将两个不同的点云进行对齐，使得它们的形状尽可能匹配。常见的方法有：

- **刚性配准**：**假设点集之间只有平移和旋转的变化**，即保持形状和距离不变。经典的算法是**ICP（Iterative Closest Point）**算法，它通过迭代地找到最近的点对，并计算最优的平移和旋转矩阵来对齐点云。
  
- **非刚性配准**：如果点云间存在形变（比如伸缩或扭曲），则需要非刚性的配准算法。这类算法不仅寻找点之间的对应关系，还需要考虑形变模型，使得两个点云的形状通过扭曲后能够匹配。

**2. 最优传输（Optimal Transport）**：

最优传输是一种用于解决分布匹配问题的方法，它可以用于点云之间的配准。**鲁棒最优传输（Robust Optimal Transport, RobOT）**方法扩展了传统的最优传输理论，使其能够在面对复杂的几何形状和采样噪声时仍能找到良好的匹配。这类方法通过构建一种概率分布，将点云中的点分布映射到目标点云的分布上，从而最小化两者之间的传输代价。

- **方法流程**：
  1. 计算两个点云之间的传输矩阵，每个点可能与目标点云中的多个点部分匹配。
  2. 使用正则化方法（如熵正则化）来使计算问题更加稳定，减少噪声的影响。
  3. 最终通过优化传输矩阵，找到点云之间的最优匹配。

**3. 特征匹配（Feature Matching）**：

在某些情况下，点云中的每个点不仅有位置信息，还可以通过计算点的**几何特征**（如曲率、法向量等）来进行匹配。这种方法通过计算每个点的局部特征向量，将点匹配到具有相似特征的目标点。

- **SIFT 或 SURF**：如果点云可以视作表面或者有其他信息（如图像上的特征），可以用类似于SIFT或SURF的特征匹配算法找到点云中相似的特征，并基于这些特征进行匹配。

**4. 基于深度学习的方法**：

利用神经网络从数据中自动学习出有效的点云表示和匹配规则，常见的模型包括**PointNet**和**Deep Closest Point (DCP)**。这些模型可以处理复杂的形状，并且在噪声较大的数据中具有较好的鲁棒性。

<u>本文章主要是探讨了如何使用**鲁棒最优传输（Robust Optimal Transport, RobOT）**来提升**点云配准**的准确性</u>(针对点云匹配中的不等规模问题)

## 鲁棒最优传输

![image-20241009215119902](C:\Users\Dell\AppData\Roaming\Typora\typora-user-images\image-20241009215119902.png)

该公式的目标是通过最优传输理论，在带有权重的点云 $ A $ 和 $ B $ 之间计算传输代价，并通过正则化项和熵模糊来控制匹配的灵活性。以下是公式的主要解释：

### 公式说明：
1. **点云与特征向量**：点云 $ A = (\alpha_i, x_i, p_i) $ 和 $ B = (\beta_j, y_j, q_j) $ 包含了非负权重 $ \alpha_i, \beta_j $、点的坐标 $ x_i, y_j $，以及特征向量 $ p_i, q_j $。特征向量可以是三维坐标，也可以是其他用于描述点属性的高维向量。
   - $ \alpha_i $：点 $ x_i $ 的权重，描述了其重要性。
   - $ x_i $：点在空间中的位置。
   - $ p_i $：特征向量，表示该点的其他特征信息（如高维描述）。
2. $ N \neq M $：意味着两个点云中点的数量不相等，增加了问题的复杂性。
3. 引入了非负权重、正则化项以及熵模糊项来解决变形配准问题。

### **最优传输目标**：

- 优化目标是找到一个传输矩阵 $ \pi_{i,j} $，它决定了如何从点集 $ A $ 的点 $ x_i $ 传输到点集 $ B $ 的点 $ y_j $。优化的目标是最小化两点云之间的代价函数：$\sum_{i=1}^{N} \sum_{j=1}^{M} \pi_{i,j} \cdot \frac{1}{2} \|p_i - q_j\|_{\mathbb{R}^D}^2$，即最小化点云特征向量 $ p_i $ 和 $ q_j $ 之间的距离，同时考虑权重和正则化项。

  - 其中 $ \pi_{i,j} $ 是传输矩阵，表示点 $ A $ 中的点 $ i $ 如何传输到点 $ B $ 中的点 $ j $。权重 $ \pi_{i,j} $ 决定了每个点的匹配程度。
  - 该项表示特征向量 $ p_i $ 和 $ q_j $ 之间的欧氏距离的平方。

- 公式中的代价函数包含三个部分：
  - $ \sum_{i=1}^{N} \sum_{j=1}^{M} \pi_{i,j} \cdot \frac{1}{2} \|p_i - q_j\|_{\mathbb{R}^D}^2 $：这是特征向量之间的距离。
  - **正则化项**：
    - **熵模糊项** $ \sigma^2 KL(\pi_{i,j} \| \alpha_i \otimes \beta_j) $：这是熵正则化，用来控制传输矩阵 $ \pi_{i,j} $ 的稀疏性，并防止过度匹配特定的点。熵正则化提高了数值稳定性，使得问题在高维空间中也能有效求解。
    - **权重匹配惩罚** $ \tau^2 KL(\sum_j \pi_{i,j} \| \alpha_i) $ 和 $ \tau^2 KL(\sum_i \pi_{i,j} \| \beta_j) $：这两项惩罚偏离原始权重分布的情况，确保传输矩阵的解不会偏离原始的点分布，点云的权重分布得到正确匹配。

- **正则化参数**：
   - 模糊半径（**blur** radius）$ \sigma $ 控制熵正则化的尺度，即模糊度，描述了点 $ x_i $ 和点 $ y_j $ 之间传输的不确定性或模糊程度，决定了变换transformation 的“分辨率”。较大的 $ \sigma $ 值表示更强的模糊匹配，即允许更多不确定的传输；而较小的 $ \sigma $ 值则会使得匹配更加精确。**启发式选择**：通常选择 $ \sigma $ 等于特征空间 $ \mathbb{R}^D $ 中的平均采样距离，以适应不同尺度的点云数据。

     - ![动图](https://pica.zhimg.com/v2-2bcb505d7b57d700831953ef6b62e83a_b.webp)

   - 最大匹配距离（**reach** distance）$ \tau $ 控制权重的惩罚力度，决定了特征向量 $ p_i $ 和 $ q_j $ 之间可以匹配的最大距离。这是对点云形变时的软限制，限制了点云的最大变形量，它确保传输矩阵遵循点集的权重分布。较大的 $ \tau $ 值允许点云之间存在较大的形变和位移，而较小的 $ \tau $ 值则限制了点之间的最大位移，使得匹配更加严格。**启发式选择**：通常选择 $ \tau $ 等于每个特征向量 $ p_i $ 的最大可能位移， 当source 和 target 的feature 距离超过 $ \tau $ 时这两者之间不存在关联（匹配）。
   
     - ![动图](https://picx.zhimg.com/v2-5ade47f33e4c5461cb64144af443d38b_b.webp)

     ### 3. **特征向量归一化**：
        - 当特征向量 $ p_i $ 和 $ q_j $ 不是简单的笛卡尔坐标时（例如深度神经网络输出的高维特征），这些特征向量需要进行归一化处理。将特征向量归一化到单位长度（即 $ \|p_i\| = \|q_j\| = 1 $），可以确保模型的数值稳定性并优化正则化参数 $ \sigma $ 和 $ \tau $ 的选择。
        - 最终，$ \sigma $ 和 $ \tau $ 的值可以在0到2之间选择，具体取决于具体应用。
   
     ### 4. **简单启发式方法**：
        - 模糊半径 $ \sigma $ 的选择应与特征空间中的平均采样距离相关，而最大匹配距离 $ \tau $ 应与特征向量可能的最大位移相关。对于神经网络输出的高维特征，归一化可以避免不期望的行为。

     ### 总结：
     - $ \sigma $ 和 $ \tau $ 是RobOT中两个重要的正则化参数，它们影响着传输矩阵的模糊性和匹配点之间的最大变形量。
     - 使用启发式规则可以有效地设置这些参数，以在不同的数据集和场景中实现鲁棒的点云配准效果。
   
- **KL 散度**：Kullback-Leibler 散度度量了两个分布之间的差异，用于在权重匹配中引入一定的灵活性。这允许在面对噪声和数据稀疏时，依然能够找到鲁棒的匹配方案。

  

### 总结：
该公式用于点云配准，特别是在点云规模不等的情况下，利用鲁棒最优传输方法，结合正则化项，以保证传输矩阵的稀疏性和匹配的稳定性。这一方法适用于高维点云数据的配准问题，尤其在噪声较大或数据分布不均的场景下表现出色。

# 2. 跑通RobOT算法：随机生成两个3D点云，计算两者之间的OT距离；



# 3. 梳理 论文section 4的scene flow estimation实验的代码和步骤：数据集的输入，预处理，距离计算，点云配准算法，以及评价指标的输出（把代码逻辑和变量的含义理清楚）

![image-20241016154025682](C:\Users\Dell\AppData\Roaming\Typora\typora-user-images\image-20241016154025682.png)

- **训练集**：synthetic **Flying3D** dataset（made up of multiple moving objects that are sampled at random from ShapeNet. We take 19,640 pairs of point clouds for training, with dense ground truth correspondences）
- **测试集**：142 scene pairs from **Kitti**, a real-world dataset. Conduct experiments using 8,192 and 30k points per scan, sampled at random from the original data.

### 采样率downsample rate for the source and target point cloud的影响
1. **采样率讨论**：实验分析了源点云和目标点云的采样率对结果的影响，并对 D-RobOT 模型的各个模块进行了广泛的消融研究。
   
2. **预处理策略**：采用了 PointPWC-Net 的预处理策略：
   - 只使用深度小于 35 米的点云。
     - 35 米以外的点云数据可能包含较多的不准确数据，对算法的精度有负面影响。
   - 从源帧和目标帧随机采样点，且不对应具体的点对。

### 采样点数量的设定
在主要的实验中，对源点云和目标点云分别采样 8,192 或 30,000 个点。与之对比，HPLFlowNet 在采样 32,768 个点时，其平均 EPE3D（3D 均方误差）为 10.87 cm（基于 142 对 KITTI 数据集的点云）。相比之下，D-RobOT 模型仅在采样 30,000 个点时就能达到更高的精度（EPE3D 为 2.23 cm）。

### 结论
实验结果表明，D-RobOT 在较低的点采样下也能实现显著更高的精度，展示了该模型在场景流估计任务中的高效性和准确性。

![image-20241016161036093](C:\Users\Dell\AppData\Roaming\Typora\typora-user-images\image-20241016161036093.png)

Number of points per 3D frames varies widely. 一个3D frame是指一个**3D 帧**，3D帧为从传感器（如激光雷达或深度摄像头）采集的一组三维点。这些点形成一个瞬时快照，描述了传感器在某个时刻看到的环境。对于自动驾驶或机器人应用来说，3D 帧通常代表传感器在某个时间点记录的周围环境。

一个 3D 帧中包含的点数可以根据采样频率、传感器的分辨率以及场景复杂性而变化：

- **低分辨率点云**：可能每帧包含几千个点，主要用于简单的场景或低精度需求的应用。

- **高分辨率点云**：每帧可能包含数万个点，可以用于高精度应用，例如精确的物体检测和环境建模。

点数越多，所包含的信息就越多。

这段内容描述了在 KITTI 数据集中，3D 帧的点数变化较大，以及在模型评估中如何处理这种情况。以下是主要内容的总结：

### 点数变化与采样策略
- **点数差异**：KITTI 数据集中的3D帧点数变化很大。在 142 对场景中，只有 57 对帧包含超过 30,000 个点。
- **采样影响**：为了研究欠采样的潜在负面影响，实验在这 57 对“点数最密集”的帧上单独评估模型性能。当将这些帧的点数下采样至 30,000 个时，会导致一些几何信息的丢失。

### 实验结果与结论
- **效果对比**：在这些帧子集的实验结果（见图 6 和表 4）表明，在包含 85 对点数不超过 30,000 的帧的完整 KITTI 数据集上，D-RobOT 方法在全分辨率下表现更好。尽管在子集中性能有所降低，但 D-RobOT 模型在所有采样率下都优于 PointPWC-Net。

![image-20241016161210444](C:\Users\Dell\AppData\Roaming\Typora\typora-user-images\image-20241016161210444.png)

![image-20241016161334639](C:\Users\Dell\AppData\Roaming\Typora\typora-user-images\image-20241016161334639.png)

总体来说，实验表明 D-RobOT 方法在处理不同采样率的数据时表现稳定，并且在点数较大（高分辨率）的场景中表现尤为突出。



在RobOT模型中，**RobOT Spline** 和 **RobOT (raw)** 的主要区别在于处理方式和适用场景：

1. **RobOT Spline**：通过样条插值（Spline interpolation）对数据进行平滑处理，适合需要局部精确拟合的情况。这种方法在处理高分辨率数据时有助于提高精度。
   
2. **RobOT (raw)**：是对数据直接进行操作的原始版本，未经过平滑处理。适用于低分辨率或不需要细致调整的场景。

Spline 更适合高分辨率时的细致调整，而 Raw 适合更简单、直接的任务。

补充背景知识：在形变模型（deformation model）部分，通常可以分为**低维参数化模型**和**非参数化模型**。低维参数化模型包括刚性（6D）和仿射（12D）变换，这类模型有固定的自由度，适用于较简单的形变场景。而非参数化模型，像位移模型、样条插值（spline）和流体形变模型（如LDDMM），则允许每个点有独立的自由度，适合处理更复杂的大形变问题。LDDMM在处理复杂形状时效果较好，但计算较慢，而刚性和仿射变换计算速度更快。

**关键点**：
- 小形变可用样条插值（spline），大形变通常使用LDDMM。
- 非参数化模型能够更好地保留复杂形状的细节，例如LDDMM对边缘的还原度较高。

总之，根据任务的复杂性和形变的大小，选择合适的形变模型非常重要，尤其在结合RobOT算法时，可以先通过RobOT快速计算对应点，再进行形变模型的正则化处理。

### 消融实验 ablation study for the modules of  the D-RobOT model

- 在这篇Ablation研究中，D-RobOT模型的预对齐和后处理模块被分析。

  - **预对齐模块**：对不同采样率都有效，主要处理刚性变换，能提升初步对齐效果。
  - **后处理模块**：只对高分辨率点云有改善效果。通过RobOT后处理进行快速的局部拟合。对于低采样率，因源点与目标点重叠较小，精细调整反而可能有害；而在高采样率下，重叠较大，后处理能显著提高精度。

  这表明，RobOT后处理适合高分辨率场景下的精细微调。

### D-RobOT Kitti 实验

![image-20241018165710806](C:\Users\Dell\AppData\Roaming\Typora\typora-user-images\image-20241018165710806.png)

在Kitti实验中，D-RobOT（详见sec3.2）模型使用了三个阶段的配准流程：

1. **刚性预对齐（S-RobOT）**：基于S-RobOT模型，通过刚性变换对源点云进行初步对齐，输入是原始的三维坐标 (x, y, z)，并通过点的权重进行调整。并将血管半径作为点的权重 $\alpha_i$ 和 $\beta_j$ 考虑（较大的血管半径表示更重要的结构信息，因此在最优传输计算中赋予这些点较大的权重）。在最优传输问题中，模糊参数 $\sigma$ 设置为1米，范围参数 $\tau$ 设置为 $\infty$，这表示在严格边缘约束下使用平衡的最优传输。

2. **深层非参数配准**：在刚性预对齐后，进行深度非参数化的形变模型配准，使用基于**多高斯核（multi-Gaussian kernel）**的样条形变模型，其标准差为 {20, 40, 60} 厘米，权重为 {0.2, 0.3, 0.5}，允许更复杂的形状变形。
   $$
   k(x, y) = 0.2 \cdot \exp \left[ -\frac{\|x - y\|_{\mathbb{R}^3}^2}{2 \cdot 20^2} \right] 
   + 0.3 \cdot \exp \left[ -\frac{\|x - y\|_{\mathbb{R}^3}^2}{2 \cdot 40^2} \right] 
   + 0.5 \cdot \exp \left[ -\frac{\|x - y\|_{\mathbb{R}^3}^2}{2 \cdot 60^2} \right]
   $$
   表示不同尺度下点之间的相似性。核函数结合了不同尺度的高斯分布，用于捕捉点云中复杂的形变关系，从而实现更精确的配准。

3. **样条后处理（Spline S-RobOT）**：最后使用样条插值进行局部调整，进一步提高配准精度。为了微调配准，使用样条 S-RobOT 形变模型，输入为 $(x, y, z)$ 坐标。模糊参数设为 $ \sigma = 5\text{cm} $，范围参数为 $ \tau = 80 \, \text{cm} $。为了平滑处理，使用了 **保持血管结构的各向异性核函数** $ k(x, y) $，该核函数的局部尺度 $ s_{\text{local}} $ 也设为 80 cm。这种后处理有助于进一步提高配准的精度。

该模型结合了速度与精度的优势。

# 4. 下载并整理KITTI数据集（如果数据集太大，就不下载完整的数据集，实验只用了142对数据）



# 5. 尝试跑通 scene flow estimation 实验的代码